version: "3.8"

services:
  # --- LAYANAN LOKAL OPSIONAL ---
  # Layanan ini HANYA akan berjalan jika Anda menjalankan
  # docker compose --profile local-services up
  
  db:
    image: docker.io/library/mongo:4.4
    profiles: ["local-services"] # Label: Opsional, hanya untuk development lokal
    ports:
      - "27017:27017" # Untuk tes koneksi dari Mongo Compass
    volumes:
      - mongo-data:/data/db
    networks:
      - worker-net

  queue:
    image: docker.io/library/redis:alpine
    profiles: ["local-services"] # Label: Opsional, hanya untuk development lokal
    ports:
      - "6379:6379" # Untuk tes koneksi dari redis-cli
    networks:
      - worker-net

  # --- LAYANAN INTI ANDA ---
  # Servis ini akan SELALU berjalan
  
  worker:
    build:
      context: . # Asumsi Dockerfile ada di folder ini
    
    environment:
      # --- SAKLAR KONEKSI ---
      # Gunakan MONGO_URI dari .env. JIKA KOSONG (:-), gunakan 'db' lokal.
      - MONGO_URI=${MONGO_URI:-mongodb://db:27017/yayasan_veritas}
      
      # Gunakan REDIS_URI dari .env. JIKA KOSONG (:-), gunakan 'queue' lokal.
      - REDIS_URI=${REDIS_URI:-redis://queue:6379}
      
      # --- KREDENSIAL CLOUD STORAGE ---
      # Variabel ini WAJIB diisi di file .env
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      
    # Kunci untuk Skenario 3: Menambahkan "jembatan"
    # ke localhost milik host (laptop/VPS Anda)
    extra_hosts:
      - "host.docker.internal:host-gateway"
      
    networks:
      - worker-net

# Jaringan agar semua kontainer bisa saling "bicara"
networks:
  worker-net:

# Volume untuk menyimpan data Mongo agar tidak hilang saat kontainer mati
volumes:
  mongo-data: